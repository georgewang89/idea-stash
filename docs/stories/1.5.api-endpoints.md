# Story 1.5: Quick Capture API Endpoint

## Status
Draft

## Story
**As a** developer,
**I want** a REST API endpoint for creating and retrieving ideas,
**so that** the frontend can save user ideas to the database securely.

## Acceptance Criteria
1. POST /api/ideas endpoint for creating new draft ideas
2. GET /api/ideas endpoint for retrieving user's ideas with filtering
3. Authentication middleware protecting all idea endpoints
4. Input validation with proper error messages
5. Database integration with Supabase for CRUD operations
6. Response format following OpenAPI specification
7. Error handling with consistent HTTP status codes

## Tasks / Subtasks
- [ ] Create ideas API route structure (AC: 1, 2)
  - [ ] Create pages/api/ideas/index.ts for GET and POST operations
  - [ ] Set up TypeScript interfaces for request/response types
  - [ ] Implement proper HTTP method routing (GET, POST)
  - [ ] Add CORS headers for frontend integration
- [ ] Implement POST /api/ideas endpoint (AC: 1)
  - [ ] Accept idea content in request body with validation
  - [ ] Set default status to 'draft' for new ideas
  - [ ] Generate UUID and timestamps for new ideas
  - [ ] Save idea to Supabase with user association
  - [ ] Return created idea with 201 status code
- [ ] Implement GET /api/ideas endpoint (AC: 2)
  - [ ] Add query parameter filtering by status (draft, committed, all)
  - [ ] Implement pagination with limit and cursor parameters
  - [ ] Retrieve user's ideas from Supabase with proper ordering
  - [ ] Return ideas array with nextCursor for pagination
- [ ] Add authentication middleware (AC: 3)
  - [ ] Create src/lib/middleware/authMiddleware.ts
  - [ ] Integrate Clerk JWT verification for protected routes
  - [ ] Extract user ID from Clerk session for database queries
  - [ ] Return 401 for unauthenticated requests
- [ ] Implement input validation (AC: 4)
  - [ ] Validate idea content length (1-10000 characters)
  - [ ] Validate status enum values (draft, committed)
  - [ ] Validate query parameters for GET requests
  - [ ] Return 400 with descriptive error messages for invalid input
- [ ] Set up database integration (AC: 5)
  - [ ] Create src/lib/repositories/ideaRepository.ts
  - [ ] Implement createIdea() function with Supabase client
  - [ ] Implement getUserIdeas() function with filtering and pagination
  - [ ] Handle database errors and connection issues
  - [ ] Use Row Level Security for user data isolation
- [ ] Configure response formatting (AC: 6)
  - [ ] Follow OpenAPI schema for idea object structure
  - [ ] Include id, content, status, created_at, committed_at fields
  - [ ] Format timestamps as ISO 8601 strings
  - [ ] Maintain consistent JSON response structure
- [ ] Add comprehensive error handling (AC: 7)
  - [ ] 400 Bad Request for validation errors
  - [ ] 401 Unauthorized for authentication failures
  - [ ] 403 Forbidden for authorization failures
  - [ ] 500 Internal Server Error for unexpected errors
  - [ ] Log errors with proper context for debugging

## Dev Notes

### Previous Story Insights
Requires Stories 1.2 (database), 1.3 (authentication) completion for Supabase and Clerk integration.

### API Specification
[Source: architecture/api-specification.md]
**POST /api/ideas Request Format:**
```json
{
  "content": "string (1-10000 characters)",
  "status": "draft" | "committed" (default: "draft")
}
```

**GET /api/ideas Query Parameters:**
- status: "draft" | "committed" | "all" (optional)
- limit: integer (default: 50, max: 100)
- cursor: string (for pagination)

**Response Format:**
```json
{
  "id": "uuid",
  "content": "string",
  "status": "draft" | "committed",
  "created_at": "ISO 8601 timestamp",
  "committed_at": "ISO 8601 timestamp | null"
}
```

### Database Integration
[Source: architecture/database-schema.md]
**Ideas Table Structure:**
- user_id: UUID foreign key (from authentication middleware)
- content: TEXT with length validation
- status: VARCHAR(20) with enum constraint
- Automatic search_vector update via trigger
- Row Level Security ensuring user data isolation

### Authentication Requirements
[Source: architecture/components.md]
**Authentication Middleware:**
- Clerk JWT verification for protected API routes
- User ID extraction for database queries
- Session validation and refresh handling
- Consistent error responses for auth failures

### File Structure Requirements
[Source: architecture/unified-project-structure.md]
- API routes: `pages/api/ideas/index.ts`
- Repository: `src/lib/repositories/ideaRepository.ts`
- Middleware: `src/lib/middleware/authMiddleware.ts`
- Types: `src/types/api.ts` for request/response interfaces

### Error Handling Pattern
[Source: architecture/api-specification.md]
Consistent error response format:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Content must be between 1 and 10000 characters",
    "details": {}
  }
}
```

### Testing Standards
[Source: architecture/testing-strategy.md]
- API tests: `__tests__/api/ideas.test.ts`
- Test authenticated and unauthenticated requests
- Test input validation with edge cases
- Test database integration with mocked Supabase
- Test error scenarios and proper HTTP status codes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-25 | 1.0 | Initial API endpoints story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*