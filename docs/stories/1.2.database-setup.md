# Story 1.2: Database Schema and Supabase Setup

## Status
Draft

## Story
**As a** developer,
**I want** a properly configured PostgreSQL database with Supabase integration and complete schema setup,
**so that** I can store and retrieve user ideas with full-text search capabilities.

## Acceptance Criteria
1. Supabase project created and configured with PostgreSQL 15+
2. Complete database schema implemented with users and ideas tables
3. Full-text search functionality enabled with tsvector and GIN indexes
4. Row Level Security (RLS) configured for multi-tenant data isolation
5. Supabase client configuration integrated into Next.js project
6. Database migration files created for version control
7. Environment variables configured for database connections

## Tasks / Subtasks
- [ ] Create and configure Supabase project (AC: 1)
  - [ ] Create new Supabase project with PostgreSQL 15+
  - [ ] Configure project settings and region selection
  - [ ] Enable necessary PostgreSQL extensions (uuid-ossp, pg_trgm)
  - [ ] Set up project API keys and connection strings
- [ ] Implement database schema (AC: 2)
  - [ ] Create users table with Clerk integration fields
  - [ ] Create ideas table with content, status, and timestamp fields
  - [ ] Add proper constraints and foreign key relationships
  - [ ] Set default values and validation rules
- [ ] Set up full-text search (AC: 3)
  - [ ] Add tsvector column to ideas table for search indexing
  - [ ] Create GIN index for search performance optimization
  - [ ] Implement trigger function for automatic search vector updates
  - [ ] Create optimized search_ideas() database function
- [ ] Configure Row Level Security (AC: 4)
  - [ ] Enable RLS on ideas table
  - [ ] Create policy for user data isolation
  - [ ] Test multi-tenant security with different user contexts
  - [ ] Verify users can only access their own ideas
- [ ] Integrate Supabase client (AC: 5)
  - [ ] Install @supabase/supabase-js package
  - [ ] Create src/lib/supabase.ts with client configuration
  - [ ] Set up TypeScript types for database schema
  - [ ] Configure authentication helpers for Clerk integration
- [ ] Create migration files (AC: 6)
  - [ ] Set up supabase/ directory structure
  - [ ] Create initial schema migration file
  - [ ] Add migration for full-text search setup
  - [ ] Document migration workflow for future schema changes
- [ ] Environment configuration (AC: 7)
  - [ ] Add DATABASE_URL to environment variables
  - [ ] Configure NEXT_PUBLIC_SUPABASE_URL and ANON_KEY
  - [ ] Update .env.local.example with database variables
  - [ ] Test connection from Next.js application

## Dev Notes

### Previous Story Insights
Depends on Story 1.1 completion for proper project structure and environment setup.

### Database Schema Requirements
[Source: architecture/database-schema.md]
**Users Table Structure:**
- Primary key: UUID with uuid_generate_v4() default
- clerk_id: VARCHAR(255) UNIQUE for Clerk authentication integration
- email, name: User profile information
- settings: JSONB for user preferences with defaults
- Timestamps: created_at, updated_at with timezone support

**Ideas Table Structure:**
- Primary key: UUID with foreign key to users(id)
- content: TEXT with length validation (1-10000 characters)
- status: VARCHAR(20) with CHECK constraint ('draft', 'committed')
- Timestamps: created_at, committed_at, updated_at
- search_vector: TSVECTOR for full-text search capabilities

### Full-Text Search Implementation
[Source: architecture/database-schema.md]
- **Extensions Required**: pg_trgm for trigram matching
- **Search Function**: search_ideas() with user isolation, query ranking, and result limiting
- **Search Features**: Highlighted results with ts_headline, ranked by relevance
- **Performance**: GIN index on search_vector for sub-200ms query times

### Security Configuration
[Source: architecture/security-and-performance.md]
- **Row Level Security**: Mandatory for multi-tenant data protection
- **Policy**: ideas_user_isolation ensures users only access their own data
- **Auth Integration**: Uses auth.uid() for Supabase-Clerk user mapping

### File Structure Requirements
[Source: architecture/unified-project-structure.md]
- Database configuration: `src/lib/supabase.ts`
- Type definitions: `src/types/database.ts` and `src/types/supabase.ts`
- Migration files: `supabase/migrations/` with timestamped SQL files
- Configuration: `supabase/config.toml` for project settings

### Testing Standards
[Source: architecture/testing-strategy.md]
- Database tests: Create `__tests__/database/` directory
- Migration testing: Verify schema changes work correctly
- RLS testing: Ensure security policies prevent data leakage
- Connection testing: Test Supabase client configuration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-25 | 1.0 | Initial database setup story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*